TT_BLACKSMITH_HOME=$(pwd)

EXPECTED_ARGS=1

if [ "$#" -gt "$EXPECTED_ARGS" ]; then
  echo "Single option for experiment type expected, possible options are: TT-XLA (--xla), TT-Forge-FE (--ffe) or GPU (--gpu)"
  return 1
fi

case $1 in
    --ffe) EXPERIMENT_TYPE=0 ;;
    --xla) EXPERIMENT_TYPE=1 ;;
    --gpu) EXPERIMENT_TYPE=2 ;;
    "")
        # No argument provided, default to TT-XLA
        echo "No type of experiment was specified, possible options are: TT-XLA (--xla), TT-Forge-FE (--ffe) or GPU (--gpu)"
        echo "Defaulting to TT-XLA (--xla)"
        EXPERIMENT_TYPE=1
        ;;
    *) echo "Unknown parameter passed: $1"; return 1 ;;
esac

# pytest alias for venv interpreter
alias pytest='python -m pytest'

# Set environment directory based on experiment type
case $EXPERIMENT_TYPE in
    0)
        export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/ffe_env
        ;;
    1)
        export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/xla_env
        ;;
    2)
        export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/gpu_env
        export PJRT_DEVICE=CUDA
        ;;
    *)
        echo "Unknown experiment type: $EXPERIMENT_TYPE"
        return 1
esac

# Function to get expected package version from requirements file
# Usage: get_expected_version <package_name> <requirements_file>
get_expected_version() {
    grep -oP "${1}==\K[^\s]+" "$2" 2>/dev/null || echo ""
}

# Function to get installed package version
# Usage: get_installed_version <package_name>
get_installed_version() {
    $TT_BLACKSMITH_ENV_DIR/bin/pip show "$1" 2>/dev/null | grep -oP '^Version: \K.*' || echo ""
}

# Function to get index URLs from requirements file
# Usage: get_index_urls <requirements_file>
get_index_urls() {
    local index_url=$(grep -oP '^--index-url\s+\K\S+' "$1" 2>/dev/null)
    local extra_index_urls=$(grep -oP '^--extra-index-url\s+\K\S+' "$1" 2>/dev/null)

    local result=""
    if [ -n "$index_url" ]; then
        result="--index-url $index_url"
    fi
    for url in $extra_index_urls; do
        result="$result --extra-index-url $url"
    done
    echo "$result"
}

# Function to check package version and force reinstall if mismatch
# Usage: check_package_version <package_name> <requirements_file>
# Returns 0 if versions match or package was updated
check_package_version() {
    local package="$1"
    local requirements="$2"
    local expected=$(get_expected_version "$package" "$requirements")
    local installed=$(get_installed_version "$package")

    if [ -n "$expected" ] && [ "$expected" != "$installed" ]; then
        echo "${package} version mismatch detected!"
        echo "  Installed: ${installed:-none}"
        echo "  Expected:  $expected"
        echo "Upgrading ${package} to version ${expected}..."
        local index_urls=$(get_index_urls "$requirements")
        pip install --force-reinstall $index_urls "${package}==${expected}"
    fi
    return 0
}

# If environment directory already exists, check versions and activate
if [ -d $TT_BLACKSMITH_ENV_DIR/bin ]; then
    if [ ! -f $TT_BLACKSMITH_ENV_DIR/bin/activate ]; then
        echo "Virtual environment directory exists but does not contain activate script,"
        echo "please remove the $TT_BLACKSMITH_ENV_DIR directory and try again"
        return
    fi

    # Activate environment
    source $TT_BLACKSMITH_ENV_DIR/bin/activate

    # Check and upgrade packages if needed based on experiment type
    case $EXPERIMENT_TYPE in
        1) check_package_version "pjrt-plugin-tt" "env/xla_requirements.txt" ;;
    esac

    return
fi

# Otherwise create it
echo "Creating virtual environment in $TT_BLACKSMITH_ENV_DIR"
python3.11 -m venv $TT_BLACKSMITH_ENV_DIR
source $TT_BLACKSMITH_ENV_DIR/bin/activate
pip install --upgrade pip

# Install dependencies based on experiment type
case $EXPERIMENT_TYPE in
    0)
        pip install -r env/ffe_requirements.txt
        ;;
    1)
        pip install -r env/xla_requirements.txt -r env/requirements.txt
        ;;
    2)
        pip install -r env/gpu_requirements.txt -r env/requirements.txt
        ;;
    *)
        echo "Unknown experiment type: $EXPERIMENT_TYPE"
        return 1
esac

pip install -e $TT_BLACKSMITH_HOME
