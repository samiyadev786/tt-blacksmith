TT_BLACKSMITH_HOME=$(pwd)

EXPECTED_ARGS=1

if [ "$#" -gt "$EXPECTED_ARGS" ]; then
  echo "Single option for experiment type expected, possible options are: TT-XLA (--xla), TT-Forge-FE (--ffe) or GPU (--gpu)"
  return 1
fi

case $1 in
    --ffe) EXPERIMENT_TYPE=0 ;;
    --xla) EXPERIMENT_TYPE=1 ;;
    --gpu) EXPERIMENT_TYPE=2 ;;
    "")
        # No argument provided, default to TT-XLA
        echo "No type of experiment was specified, possible options are: TT-XLA (--xla), TT-Forge-FE (--ffe) or GPU (--gpu)"
        echo "Defaulting to TT-XLA (--xla)"
        EXPERIMENT_TYPE=1
        ;;
    *) echo "Unknown parameter passed: $1"; return 1 ;;
esac

export SYSTEM_DIST_PACKAGES="/usr/local/lib/python3.11/dist-packages"
export PYTHONPATH="$(pwd):$(pwd)/tests:$SYSTEM_DIST_PACKAGES"
# pytest alias for venv interpreter
alias pytest='python -m pytest'

# Set environment directory based on experiment type
case $EXPERIMENT_TYPE in
    0)
        export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/ffe_env
        ;;
    1)
        export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/xla_env
        ;;
    2)
        export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/gpu_env
        export PJRT_DEVICE=CUDA
        ;;
    *)
        echo "Unknown experiment type: $EXPERIMENT_TYPE"
        return 1
esac

# If environment directory already exists, activate it
if [ -d $TT_BLACKSMITH_ENV_DIR/bin ]; then
    if [ -f $TT_BLACKSMITH_ENV_DIR/bin/activate ]; then
        source $TT_BLACKSMITH_ENV_DIR/bin/activate
    else
        echo "Virtual environment directory exists but does not contain activate script,"
        echo "please remove the $TT_BLACKSMITH_ENV_DIR directory and try again"
        return
    fi
    return
fi

# Otherwise create it
echo "Creating virtual environment in $TT_BLACKSMITH_ENV_DIR"
python3.11 -m venv $TT_BLACKSMITH_ENV_DIR
source $TT_BLACKSMITH_ENV_DIR/bin/activate
pip install --upgrade pip

# Install dependencies based on experiment type
case $EXPERIMENT_TYPE in
    0)
        pip install -r env/ffe_requirements.txt
        ;;
    1)
        pip install -r env/xla_requirements.txt -r env/requirements.txt
        ;;
    2)
        pip install -r env/gpu_requirements.txt -r env/requirements.txt
        ;;
    *)
        echo "Unknown experiment type: $EXPERIMENT_TYPE"
        return 1
esac

# Install base dependencies
pip install -e $TT_BLACKSMITH_HOME
